name: Set Up Test Cluster
description: Set up Turing Test Cluster

inputs:
  go-version:
    required: true
    description: 'Go Version'
    default: ''
  turing_api_tar_archive_name:
    required: true
    description: 'Turing API tar Archive Name'
    default: ''
  turing_router_tar_archive_name:
    required: true
    description: 'Turing Router tar Archive Name'
    default: ''
  experiment_engine_plugin_archive_name:
    required: true
    description: 'Experiment Engine tar Archive Name'
    default: ''
  use_in_cluster_config:
    required: true
    description: 'Matrix: useInClusterConfig'
    default: ''
  values_file:
    required: true
    description: 'Matrix: valuesFile'
    default: ''
  cluster_name:
    required: true
    description: 'Name of Cluster'
    default: ''
  local_registry:
    required: true
    description: 'Endpoint of local registry'
    default: ''

runs:
  using: composite
  steps:
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ inputs.go-version }}

    - name: Download Turing API Docker tar archive
      uses: actions/download-artifact@v2
      with:
        name: ${{ inputs.turing_api_tar_archive_name }}

    - name: Download Turing Router Docker tar archive
      uses: actions/download-artifact@v2
      with:
        name: ${{ inputs.turing_router_tar_archive_name }}

    - name: Download Experiment Engine Plugin Docker tar archive
      uses: actions/download-artifact@v2
      with:
        name: ${{ inputs.experiment_engine_plugin_archive_name }}

    - name: "Setup local k8s cluster"
      uses: AbsaOSS/k3d-action@v2.3.0
      with:
        cluster-name: ${{ inputs.cluster_name }}
        args: >-
          --servers 1
          --agents 3
          --port 80:80@agent:*
          --registry-create ${{ inputs.local_registry }}
          --k3s-arg "--no-deploy=traefik,metrics-server@server:*"

    - name: Publish Turing images to local registry
      shell: bash
      env:
        DOCKER_REPOSITORY: ${{ inputs.LOCAL_REGISTRY }}/${{ github.repository }}
      run: |
        # Turing API
        docker image load --input turing-api.${{ env.TURING_API_VERSION }}.tar
        docker tag \
          turing-api:${{ env.TURING_API_VERSION }} \
          ${{ env.DOCKER_REPOSITORY }}/turing-api:${{ env.TURING_API_VERSION }}
        docker push ${{ env.DOCKER_REPOSITORY }}/turing-api:${{ env.TURING_API_VERSION }}
        
        # Turing Router
        docker image load --input turing-router.${{ env.TURING_ROUTER_VERSION }}.tar
        docker tag \
          turing-router:${{ env.TURING_ROUTER_VERSION }} \
          ${{ env.DOCKER_REPOSITORY }}/turing-router:${{ env.TURING_ROUTER_VERSION }}
        docker push ${{ env.DOCKER_REPOSITORY }}/turing-router:${{ env.TURING_ROUTER_VERSION }}
        
        # Experiment Engine Plugin
        docker image load --input test-experiment-engine-plugin.${{ env.TEST_EXPERIMENT_ENGINE_PLUGIN_VERSION }}.tar
        docker tag \
          plugin-example-engine-plugin:${{ env.TEST_EXPERIMENT_ENGINE_PLUGIN_VERSION }} \
          ${{ env.DOCKER_REPOSITORY }}/test-experiment-engine-plugin:${{ env.TEST_EXPERIMENT_ENGINE_PLUGIN_VERSION }}
        docker push ${{ env.DOCKER_REPOSITORY }}/test-experiment-engine-plugin:${{ env.TEST_EXPERIMENT_ENGINE_PLUGIN_VERSION }}

    - name: Prepare cluster credentials without vault
      shell: bash
      run: |
        # FOR TURING
        k3d kubeconfig get ${{ inputs.CLUSTER_NAME }} >/tmp/temp_kubeconfig.yaml
        tee credentials.json << EOF
        {
            "k8s_config": {
                "name": $(yq .clusters[0].name -o json /tmp/temp_kubeconfig.yaml),
                "cluster": $(yq '.clusters[0].cluster | .server = "https://kubernetes.default.svc.cluster.local:443"' -o json /tmp/temp_kubeconfig.yaml),
                "user": $(yq .users[0].user -o json /tmp/temp_kubeconfig.yaml)
            }
        }
        EOF
        # get yaml file
        yq e -P credentials.json -o yaml >/tmp/temp_k8sconfig.yaml

        # NOTE: Add credentials to for e2e-test
        yq '.cluster.credentials |= load("/tmp/temp_k8sconfig.yaml")' -i api/e2e/test/config.yaml

    - name: Install Turing
      shell: bash
      run: |
        if [[ ${{inputs.use_in_cluster_config}} == false ]]; then
          output=$(yq e -o json '.k8s_config' /tmp/temp_k8sconfig.yaml | jq -r -M -c .)
          output="$output" yq '.merlin.environmentConfigs[0] *= load("/tmp/temp_k8sconfig.yaml") | .merlin.imageBuilder.k8sConfig |= strenv(output)' -i infra/e2e/${{ inputs.values_file }}
          yq '.environmentConfigs.[0].k8s_config |= load("/tmp/temp_k8sconfig.yaml").k8s_config | .environmentConfigs.[0].name |= load("infra/e2e/${{ inputs.values_file }}").merlin.environmentConfigs.[0].name' -i infra/e2e/${{ inputs.values_file }}
          yq '.config.ClusterConfig.EnsemblingServiceK8sConfig |= load("/tmp/temp_k8sconfig.yaml").k8s_config' -i infra/e2e/${{ inputs.values_file }}
        fi
        helm repo add caraml https://caraml-dev.github.io/helm-charts
        helm install turing caraml/turing \
          --values infra/e2e/turing.values.yaml \
          --values infra/e2e/${{ inputs.values_file }} \
          --set deployment.image.registry=${{ inputs.LOCAL_REGISTRY }} \
          --set deployment.image.repository=${{ github.repository }}/turing-api \
          --set deployment.image.tag=${{ env.TURING_API_VERSION }} \
          --set config.RouterDefaults.Image=${{ inputs.LOCAL_REGISTRY }}/${{ github.repository }}/turing-router:${{ env.TURING_ROUTER_VERSION }} \
          --set experimentEngines[0].rpcPlugin.image=${{ inputs.LOCAL_REGISTRY }}/${{ github.repository }}/test-experiment-engine-plugin:${{ env.TEST_EXPERIMENT_ENGINE_PLUGIN_VERSION }}

    - name: Install mockserver
      shell: bash
      run: |
        kubectl apply -f infra/e2e/turing.mockserver.yaml

    - name: Run action await k8 workloads
      uses: jupyterhub/action-k8s-await-workloads@v1
      id: wait-for-deployment
      with:
        workloads: >-
          deployment/mockserver,
          deployment/turing-mlp,
          deployment/turing-merlin,
          deployment/turing
        timeout: 600 # seconds
        max-restarts: -1

    - name: Kubernetes namespace report
      uses: jupyterhub/action-k8s-namespace-report@v1
      if: ${{ failure() }}

    - name: Setup MLP project
      shell: bash
      run: |
        tee payload.json <<EOF
        {
          "name": "default",
          "team": "myteam",
          "stream": "mystream"
        }
        EOF
        
        curl -v \
          --header 'Content-Type: application/json' \
          --request POST \
          --data @payload.json \
          http://turing-gateway.127.0.0.1.nip.io/api/v1/projects

    - name: Cache Test Dependencies
      uses: actions/cache@v2
      with:
        path: api/.go/pkg/mod/
        key: |
          gomod-${{ hashFiles('api/go.mod') }}
        restore-keys: gomod-
